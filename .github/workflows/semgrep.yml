name: Comprehensive DevSecOps Pipeline (SAST, SCA, DAST)

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  security_checks:
    runs-on: ubuntu-latest
    
    # Define a default variable for the target URL for DAST
    env:
      DAST_TARGET_URL: http://localhost:5000

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for advanced scanners

      # ===============================================
      # 1. SETUP: Python Environment and Dependencies
      # ===============================================
      - name: Set up Python Environment and Install Dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Application Dependencies
        run: pip install -r requirements.txt
        working-directory: . # Assumes requirements.txt is in the root

      # ===============================================
      # 2. SAST (Static Analysis - Code Quality)
      # ===============================================
      - name: Run Semgrep SAST Scan (Code Analysis)
        uses: semgrep/semgrep-action@v2
        id: semgrep_sast
        with:
          config: auto
          # Policy: Fail the build on any High/Critical finding
          fail_on: "error"
          # Output SARIF for GitHub Security Dashboard integration
          output: semgrep-sast.sarif
          publish: 'always' # Upload to dashboard

      # ===============================================
      # 3. SCA (Software Composition Analysis - Dependencies)
      # ===============================================
      - name: Run Trivy SCA Scan (Dependency Check)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          input: '.' # Scan the entire filesystem (where requirements.txt was processed)
          # Policy: Fail the build if Critical or High severity vulnerabilities are found
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          # Output SARIF for GitHub Security Dashboard integration
          format: 'sarif'
          output: 'trivy-sca.sarif'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          upload-sarif: true
          
      # ===============================================
      # 4. DAST (Dynamic Analysis - Running App)
      # ===============================================
      
      # Step 4.1: Start the Flask application in the background
      - name: Start Flask Application
        run: |
          echo "Starting application on port 5000..."
          python main.py & 
          # Give the application time to start up before ZAP hits it
          sleep 15 
        working-directory: .

      # Step 4.2: Run OWASP ZAP Baseline DAST Scan
      - name: Run ZAP DAST Scan
        uses: zaproxy/action-baseline@v0.11.0 
        id: zap_scan
        with:
          target: ${{ env.DAST_TARGET_URL }}
          # CRITICAL GATING: Fail the GitHub Action if ZAP finds any alerts
          fail_action: true 
          # Custom rules file to define which alerts (severity/type) should fail the build
          rules_file: '.zap/ci_policy_rules.yaml' 
          
      # Step 4.3: Upload ZAP SARIF Report to GitHub Dashboard
      # The ZAP action above generates a report named 'gl-dast-report.json' or similar.
      # We need a separate step to convert/upload a SARIF format report if we want 
      # it in the Security Dashboard alongside Semgrep/Trivy. For simplicity,
      # we'll upload the HTML report as an artifact and ensure the failure gate is in place.
      # NOTE: For advanced DAST, a dedicated ZAP API Runner is needed for SARIF.
      - name: Upload DAST HTML Report Artifact (Audit)
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: zap_report.html
          if: success() || failure()
